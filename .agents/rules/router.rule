---
description: 核心路由规则 - 让 Agent 每次开窗先读记忆并检查状态
---
# Antigravity Router (v2.1)

本规则是 Agent 的"前额叶"，负责在所有请求处理前，先确定上下文和状态。

## 0. 记忆优先原则 (Memory First)
> **Mandatory**: Every new session MUST start by reading the active context.

- **Trigger**: 任何新 Session 的第一条 User Request，或 User 说 "继续"/"开始"/"早"。
- **Action**:
    1.  **Silent Check**: 立即调用 `view_file` 读取 `.agent/memory/active_context.md`。
    2.  **State Machine Check**: 检查 `task_status` 字段，确定当前状态。
    3.  **Context Injection**: 将 `active_context.md` 中的 `Task Queue` 和 `Current Goal` 作为本轮对话的系统级提示词。
    4.  **Auto-Suggestion**: 
        - IF `task_status == BLOCKED`: "上次任务 [Task-X] 遇到问题，需要人工介入。"
        - IF `task_status == EXECUTING`: "上次任务 [Task-X] 执行中断，是否继续？"
        - IF PENDING tasks exist: "上次任务 [Task-X] 未完成，是否继续？"

## 1. 任务分发 (Task Dispatch)
| 触发条件 | 路由目标 |
|---------|---------| 
| User 描述新需求 | → `prd-crafter-lite` |
| PRD 状态为 CONFIRMED | → `feature-flow` 工作流 |
| 检测到报错信息 | → `analyze-error` 工作流 |
| User 说 "回滚" / "撤销" | → `feature-flow` 的 Rollback Command |
| User 说 "跳过" | → 标记当前任务 BLOCKED，执行下一个 |
| User 说 "进化" / "学习" / "升级" | → `evolve.md` 工作流 |
| User 说 "反思" / "总结" | → `reflect.md` 工作流 |
| User 说 "知识 [query]" | → `knowledge.md` 工作流 |
| User 说 "模式 [query]" | → `patterns.md` 工作流 |
| User 说 "/meta [desc]" 或 "系统改进" | → `meta.md` 工作流 (修改 Agent OS 本身) |

## 2. 门禁规则 (Gatekeeper)
- **Ambiguity Check**: 如果需求模糊 -> **拦截请求**，强制反问，直到澄清。
- **State Guard**: 不允许执行不合法的状态转换（参考 `state_machine.md`）。
- **Conflict Guard**: 执行任务前检查 `git status`，有未提交修改需先处理。
- **No Manual**: 除非 User 明确要求，否则不要让 User 手动执行 `flutter run`，尽可能使用 `run_command`。

## 3. 快捷命令 (Quick Commands)
| 命令 | 作用 |
|-----|-----|
| `/start` | 触发 `start.md` 工作流，静默启动 |
| `/suspend` | 触发 `suspend1.md` 工作流，保存状态 |
| `/feature-flow` | 直接进入全自动交付流水线 |
| `/analyze-error` | 手动触发错误分析 |
| `/rollback` | 回滚到上一个检查点 |
| `/status` | 显示当前状态机状态和任务进度 |
| `/evolve` | 🧬 手动触发进化引擎，处理学习队列 |
| `/reflect` | 💭 触发反思，总结经验教训 |
| `/knowledge [query]` | 📚 查询知识库 |
| `/patterns [query]` | 🔄 查询代码模式库 |
| `/meta [desc]` | 🔧 修改 Agent OS 系统本身 |

## 4. 进化引擎自动行为 (Evolution Auto Behaviors)
> 这些行为自动触发，无需用户命令。

| 触发事件 | 自动行为 |
|---------|---------|
| 任务 (T-xxx) 完成 | 将代码变更加入 `learning_queue.md` |
| Auto-Fix 成功 | 将错误修复加入 `learning_queue.md` (P1) |
| 工作流完成 | 更新 `workflow_metrics.md` 指标 |
| 状态 → ARCHIVING | 自动触发 `/reflect` 工作流 |
| 状态 → IDLE 且队列不为空 | 处理 `learning_queue.md` 中 P0/P1 素材 |

